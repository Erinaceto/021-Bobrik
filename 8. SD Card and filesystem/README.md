# SD карта и файловая система

## Задание
1) Соберите схему как в доп. ДЗ к занятию про таймеры, запустите ШИМ; снимайте данные АЦП каждые 100 мкс и запишите их в файл в ОЗУ вашего МК в виде электронной таблицы CSV:

`"%lu; %f\n", time_mcsec, u_volts`

2) Предоставьте доступ к этой таблице по интерфейсу USB.

## Подготовка
1) Сама схема, настройка таймеров и АЦП были взяты из предыдущего ДЗ. Единственное, был добавлен таймер 5 для подсчёта времени,

2) Далее необходимо реализовать сохранение данных с АЦП в файл. Для этого нужно подключить библиотеку FATFs. НАстройки можно оставить стандартными. Но основная часть это прописать работу основных функций: чтения, записи, инициализации и IO контроля. В качестве носителя будем использовать оперативную память: 512 КБ размер сектора, 37 - их количество. Сами 4 функции можно написать прямо в заготовках FATFs, однако на будущее можно реализовать модуль драйвера ram_disk. в "с" файле пропищем статический массив накопитель и реализации функций. В "h" файле пропишем константы размеров и прототипы.
3) Некоторый момент: каждый раз при запуске необходимо форматировать диск, при этом размер очень маленький, потому стандартно это сделать не выйдет. Тут необходимо провернуть некоторый "цыганский фокус" записью чистой файловой системы в флеш память, и копирования данной файловой системы в оперативную память.
4) После необходимо подключить библиотеку для работы с USB, в режиме mass storage class. Она так же даёт заготовки для основных функций. И наш драйвер позволяет FATFs и USB общаться с файловым хранилищем единообразно, и допускать меньше ошибок.
5) Теперь необходимо сделать само сохранение значения в файл. Вариант с постоянным открытием, записью и закрытием файла надёжный, но очень неэффективный. Вариант с разовым открытием, постоянной записью и закрытием в конце эффективен, но если МК сломается, то все данные потеряются, так как сохранение идёт в буффер, и в файл идёт запись только при закрытии файла. Потому наиболее адекватным вариантом будет остановиться посередине: определить некий буффер, записывать в него значения и, при его переполнении, открыть файл, записать, и закрыть файл. Однако, запись буффера занятие довольно долгое, прям очень долгое. Поэтому сама запись буффера в файл делается в основном цикле, в то время как в прерывании идёт запись значений в сам буффер, проверка на переполнение и поднятие флага о переполнении. Но, если во время записи буффер поменяется, то есть риск повреждения данных. Поэтому используется 2 буффера. Первый буффер хранит значения АЦП. При его переполнении данные копируются не в файл, а другой буффер, так как это быстрее, и лечге уложиться в рамки между замерами. И уже со второго буффера данные записываются в файл.
6) Результат: есть возможность сохранения данных в файл прямо во время замеров. При том риск потери всех данных минимален(по идее).